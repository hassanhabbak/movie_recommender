---

title: Movie Recommender

keywords: fastai
sidebar: home_sidebar

summary: "This is a movie recommender implementation of user to movie and movie to movie recommendations. The methods used are primarily focused on embeddings to extrapolate similarity between users and items."
description: "This is a movie recommender implementation of user to movie and movie to movie recommendations. The methods used are primarily focused on embeddings to extrapolate similarity between users and items."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://hassanhabbak.github.io/movie_recommender/">https://hassanhabbak.github.io/movie_recommender/</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dependencies">Dependencies<a class="anchor-link" href="#Dependencies"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>conda create --name &lt;env&gt; --file requirements.txt</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use">How to use<a class="anchor-link" href="#How-to-use"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="movies_metadata-module">movies_metadata module<a class="anchor-link" href="#movies_metadata-module"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Loading in the meta data features:</p>
<ul>
<li>Cleans data from duplicates</li>
<li>Convert adult tag on movies to bool</li>
<li>Label Encodes genres after cleanning</li>
<li>Drops incorrect Iso for languages</li>
<li>Gets numerical features and corrects wrong values</li>
<li>Bucketizes the decade the movie was launched in</li>
<li>Creates a flag of whether the movie is recent or not</li>
<li>NLP processing of overview description (TFIDF + LDA)</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">meta_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/movies_metadata.csv&#39;</span><span class="p">)</span>
<span class="n">movies_df</span> <span class="o">=</span> <span class="n">mmd</span><span class="o">.</span><span class="n">get_movie_features</span><span class="p">(</span><span class="n">meta_df</span><span class="p">)</span>
<span class="n">movies_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>C:\Users\hhapp\anaconda3\envs\tensorflow\lib\site-packages\IPython\core\interactiveshell.py:3063: DtypeWarning: Columns (10) have mixed types.Specify dtype option on import or set low_memory=False.
  interactivity=interactivity, compiler=compiler, result=result)
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>adult</th>
      <th>vote_count</th>
      <th>vote_average</th>
      <th>runtime</th>
      <th>popularity</th>
      <th>decade_label</th>
      <th>released_recently</th>
      <th>G_0</th>
      <th>G_1</th>
      <th>G_2</th>
      <th>...</th>
      <th>G_10</th>
      <th>G_11</th>
      <th>G_12</th>
      <th>G_13</th>
      <th>G_14</th>
      <th>G_15</th>
      <th>G_16</th>
      <th>G_17</th>
      <th>G_18</th>
      <th>G_19</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>862</th>
      <td>False</td>
      <td>5415.0</td>
      <td>7.7</td>
      <td>81.0</td>
      <td>21.946943</td>
      <td>2.0</td>
      <td>False</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>8844</th>
      <td>False</td>
      <td>2413.0</td>
      <td>6.9</td>
      <td>104.0</td>
      <td>17.015539</td>
      <td>2.0</td>
      <td>False</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>15602</th>
      <td>False</td>
      <td>92.0</td>
      <td>6.5</td>
      <td>101.0</td>
      <td>11.712900</td>
      <td>2.0</td>
      <td>False</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>31357</th>
      <td>False</td>
      <td>34.0</td>
      <td>6.1</td>
      <td>127.0</td>
      <td>3.859495</td>
      <td>2.0</td>
      <td>False</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>11862</th>
      <td>False</td>
      <td>173.0</td>
      <td>5.7</td>
      <td>106.0</td>
      <td>8.387519</td>
      <td>2.0</td>
      <td>False</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows Ã— 27 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="users-module">users module<a class="anchor-link" href="#users-module"> </a></h2><p>Collaborative filtering is a technique that usually relies on matrix factorization to reduce a fat matrix to two thin ones, horizontally for user similarity, and vertically for item similarity. Using matrix completition, we could deduce how likely one user is to rate another. However the dataset of user iteractions is large and can become bigger by time. This is why I selected NN approach.</p>
<p>In this approach, a network is constructed to have two embedding layers learned against the movie rating as a target. One layer is for the user, the other is for the movie. The network weights for the layer is optimized to reduce the error in predicting the rating. The vectors from the embedding layers then will be the vector representation of similarity of movies and users.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Using-NN-collaborative-filtering">Using NN collaborative filtering<a class="anchor-link" href="#Using-NN-collaborative-filtering"> </a></h4><p>In this part, the users and movies are represented as label encoded input to the network. Only the rating behavior is then the deciding factor for helping the model converge on a solution.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ratings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/ratings.csv&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">,</span> <span class="n">user_le</span><span class="p">,</span> <span class="n">movie_le</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">add_labels</span><span class="p">(</span><span class="n">ratings_df</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userId</th>
      <th>movieId</th>
      <th>rating</th>
      <th>timestamp</th>
      <th>user_label</th>
      <th>movie_label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>81834</td>
      <td>5.0</td>
      <td>1425942133</td>
      <td>0</td>
      <td>16196</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>112552</td>
      <td>5.0</td>
      <td>1425941336</td>
      <td>0</td>
      <td>23638</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>98809</td>
      <td>0.5</td>
      <td>1425942640</td>
      <td>0</td>
      <td>20011</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>99114</td>
      <td>4.0</td>
      <td>1425941667</td>
      <td>0</td>
      <td>20089</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>858</td>
      <td>5.0</td>
      <td>1425941523</td>
      <td>0</td>
      <td>843</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movie_train</span><span class="p">,</span> <span class="n">movie_val</span><span class="p">,</span> <span class="n">movie_test</span><span class="p">,</span> <span class="n">user_train</span><span class="p">,</span> \
<span class="n">user_val</span><span class="p">,</span> <span class="n">user_test</span><span class="p">,</span> <span class="n">rating_train</span><span class="p">,</span> <span class="n">rating_val</span><span class="p">,</span> \
<span class="n">rating_test</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">create_training_data</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">movie_label</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">user_label</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">rating</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span><span class="p">,</span> <span class="n">history</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">train_nn_user_behaviour</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">movie_train</span><span class="p">,</span> <span class="n">movie_val</span><span class="p">,</span> <span class="n">user_train</span><span class="p">,</span> <span class="n">user_val</span><span class="p">,</span> <span class="n">rating_train</span><span class="p">,</span> <span class="n">rating_val</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To extract the embedding layers:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movie_vec</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">extract_weights</span><span class="p">(</span><span class="s1">&#39;movie_vec&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<span class="n">user_vec</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">extract_weights</span><span class="p">(</span><span class="s1">&#39;user_vec&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And to produce the output, use:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">users</span><span class="o">.</span><span class="n">get_user_movie_output</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">eval_df</span><span class="p">,</span> <span class="n">user_le</span><span class="p">,</span> <span class="n">movie_le</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Using-content-similarity-and-collaborative-embeddings">Using content similarity and collaborative embeddings<a class="anchor-link" href="#Using-content-similarity-and-collaborative-embeddings"> </a></h4><p>For this part, the movies are now represented as a dimenstionally reduced vector of the metadata features for the movie. This is combined with the movie embeddings from the previous NN to have a representation of both content similarity and user behaviour similarity. Once combined, I apply UMAP on top to reduce the dimensionality and construct cosine similarity matrix that will have the distance between -1 to 1 for all movies and each other.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movie_to_movie_df</span> <span class="o">=</span> <span class="n">get_movie_to_movie_rating</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">movie_le</span><span class="p">,</span> <span class="n">embedding_df</span><span class="p">)</span>
<span class="n">movie_to_movie_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;output/movie_to_movie.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

